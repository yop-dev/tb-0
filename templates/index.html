<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TB Cough Detection</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-light: #dbeafe;
            --success-color: #16a34a;
            --success-light: #dcfce7;
            --danger-color: #dc2626;
            --danger-light: #fee2e2;
            --warning-color: #d97706;
            --warning-light: #fef3c7;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.5;
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem;
        }

        @media (min-width: 640px) {
            .container {
                padding: 2rem;
            }
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        @media (min-width: 640px) {
            .header {
                margin-bottom: 3rem;
                padding: 3rem;
            }
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        @media (min-width: 640px) {
            .header h1 {
                font-size: 2.5rem;
                margin-bottom: 1rem;
            }
        }

        .header p {
            color: var(--gray-700);
            font-size: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        @media (min-width: 640px) {
            .header p {
                font-size: 1.1rem;
            }
        }

        .instructions {
            background: var(--primary-light);
            border-left: 4px solid var(--primary-color);
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
        }

        .instructions h2 {
            color: var(--primary-color);
            font-size: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .instructions ol {
            list-style-position: inside;
            margin-left: 1rem;
        }

        .instructions li {
            margin-bottom: 0.75rem;
            color: var(--gray-700);
        }

        .instructions li:last-child {
            margin-bottom: 0;
        }

        .warning {
            background: var(--warning-light);
            border-left: 4px solid var(--warning-color);
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
        }

        .warning h2 {
            color: var(--warning-color);
            font-size: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .warning p {
            color: var(--gray-700);
            margin-bottom: 0.75rem;
        }

        .warning p:last-child {
            margin-bottom: 0;
        }

        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            margin-bottom: 2rem;
        }

        @media (min-width: 640px) {
            .controls {
                padding: 2rem;
            }
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (min-width: 640px) {
            .button-group {
                flex-direction: row;
            }
        }

        button { 
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            border-radius: 0.5rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        @media (min-width: 640px) {
            button {
                width: auto;
            }
        }

        button:active {
            transform: scale(0.98);
        }

        #recordButton {
            background-color: var(--primary-color);
            color: white;
        }

        #recordButton:hover {
            background-color: #1d4ed8;
        }

        #recordButton.recording {
            background-color: var(--danger-color);
            animation: pulse 1.5s infinite;
        }

        #processButton {
            background-color: var(--success-color);
            color: white;
        }

        #processButton:hover:not(:disabled) {
            background-color: #15803d;
        }

        #resetButton {
            background-color: var(--gray-700);
            color: white;
        }

        #resetButton:hover {
            background-color: var(--gray-900);
        }

        button:disabled {
            background-color: var(--gray-300);
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            margin: 1.5rem 0;
        }

        .progress-bar {
            height: 8px;
            background-color: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .cough-count {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            color: var(--gray-700);
            margin: 1rem 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        @media (min-width: 640px) {
            .cough-count {
                font-size: 1.1rem;
                justify-content: flex-start;
            }
        }

        .cough-count .count {
            font-weight: 600;
            color: var(--primary-color);
        }

        .result-container {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        @media (min-width: 640px) {
            .result-container {
                padding: 2rem;
            }
        }

        .summary {
            background-color: var(--gray-100);
            padding: 1.25rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 640px) {
            .summary {
                padding: 1.5rem;
            }
        }

        .summary h2 {
            color: var(--gray-900);
            font-size: 1.25rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        @media (min-width: 640px) {
            .summary h2 {
                font-size: 1.5rem;
                text-align: left;
            }
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .summary-item {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            text-align: center;
        }

        @media (min-width: 640px) {
            .summary-item {
                text-align: left;
            }
        }

        .summary-item h3 {
            font-size: 0.875rem;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .summary-item p {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .individual-results {
            margin-top: 2rem;
        }

        .individual-results h2 {
            color: var(--gray-900);
            font-size: 1.25rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        @media (min-width: 640px) {
            .individual-results h2 {
                font-size: 1.5rem;
                text-align: left;
            }
        }

        .cough-result {
            background: white;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0.5rem;
            border-left: 4px solid var(--gray-300);
            transition: all 0.2s;
        }

        .cough-result:hover {
            transform: translateX(4px);
        }

        .cough-result.positive {
            border-left-color: var(--danger-color);
        }

        .cough-result.negative {
            border-left-color: var(--success-color);
        }

        .cough-result h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .cough-result p {
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .confidence-bar {
            height: 4px;
            background-color: var(--gray-200);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .recording-indicator {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--danger-color);
            font-weight: 500;
            margin-top: 0.5rem;
        }

        @media (min-width: 640px) {
            .recording-indicator {
                justify-content: flex-start;
            }
        }

        .recording-indicator.active {
            display: flex;
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            background-color: var(--danger-color);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        .error-message {
            text-align: center;
            padding: 1rem;
        }

        .error-message h3 {
            color: var(--danger-color);
            margin-bottom: 0.5rem;
        }

        .error-message p {
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { 
                transform: translateY(20px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .processing-animation {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease-out;
        }

        .processing-animation .dots {
            display: flex;
            gap: 0.25rem;
        }

        .processing-animation .dot {
            width: 4px;
            height: 4px;
            background-color: currentColor;
            border-radius: 50%;
            animation: pulse 1.4s infinite;
        }

        .processing-animation .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .processing-animation .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .processing-animation svg {
            animation: spin 1s linear infinite;
        }

        /* Add safe area insets for modern mobile browsers */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(1rem, env(safe-area-inset-left));
                padding-right: max(1rem, env(safe-area-inset-right));
                padding-top: max(1rem, env(safe-area-inset-top));
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
            }
        }

        .info-button {
            z-index: 2000;
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, var(--primary-color) 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 2rem;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: auto;
            min-width: auto;
        }

        .info-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
            background: linear-gradient(135deg, #2563eb 0%, var(--primary-color) 100%);
        }

        .info-button:active {
            transform: translateY(0);
        }

        .info-button svg {
            width: 20px;
            height: 20px;
        }

        .info-button .button-text {
            display: inline;
            white-space: nowrap;
        }

        .info-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 500px;
            height: 100%;
            background: linear-gradient(135deg, #f8fafc 0%, #fff 100%);
            box-shadow: 0 8px 32px rgba(37, 99, 235, 0.10), 0 1.5px 6px rgba(0,0,0,0.06);
            border: 1.5px solid #e0e7ef;
            border-radius: 1.5rem;
            padding: 3.5rem 2rem 2rem 2rem;
            overflow-y: auto;
            transition: right 0.3s cubic-bezier(0.4,0,0.2,1), opacity 0.3s cubic-bezier(0.4,0,0.2,1);
            opacity: 0;
            z-index: 3000;
            animation: fadeInPanel 0.4s cubic-bezier(0.4,0,0.2,1);
        }

        .info-panel.active {
            right: 0;
            opacity: 1;
        }

        @keyframes fadeInPanel {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        .info-panel h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-panel .section-divider {
            border: none;
            border-top: 1.5px solid #e0e7ef;
            margin: 2rem 0 1.5rem 0;
        }

        .info-panel .section-icon {
            color: var(--primary-color);
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        .info-panel .stat-block {
            display: flex;
            gap: 1.5rem;
            margin: 1.5rem 0 1.5rem 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        .info-panel .stat-item {
            background: #e0e7ef;
            color: #1e293b;
            border-radius: 0.75rem;
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            font-size: 1.1rem;
            min-width: 140px;
            flex: 1 1 140px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(37,99,235,0.04);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 70px;
        }

        .info-panel h3 {
            font-size: 1.15rem;
            margin: 1.25rem 0 0.5rem 0;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .info-panel p {
            color: #334155;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        @media (max-width: 640px) {
            .info-panel {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                top: auto;
                width: 100vw;
                max-width: 100vw;
                height: 70vh;
                border-radius: 1.5rem 1.5rem 0 0;
                box-shadow: 0 -4px 24px rgba(37,99,235,0.10), 0 1.5px 6px rgba(0,0,0,0.06);
                animation: slideUpPanel 0.4s cubic-bezier(0.4,0,0.2,1);
                padding: 3.5rem 1rem 1.5rem 1rem;
                z-index: 1001;
            }
            @keyframes slideUpPanel {
                from { transform: translateY(100%); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .info-overlay {
                background: rgba(0, 0, 0, 0.2);
            }
            .info-panel .stat-block {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }
            .info-panel .stat-item {
                min-width: 0;
                width: 100%;
            }
            .info-panel .close-button {
                display: none !important;
            }
        }

        .info-overlay {
            z-index: 1000;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .info-overlay.active {
            z-index: 2001;
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .info-panel .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #f1f5f9;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 0.5rem 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
            z-index: 2;
            font-size: 1.5rem;
            line-height: 1;
            box-shadow: 0 1px 4px rgba(37,99,235,0.04);
        }

        .info-panel .close-button:hover {
            background-color: #e0e7ef;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>TB Cough Detection</h1>
            <p>A screening tool to help identify potential tuberculosis symptoms through cough analysis using machine learning.</p>
        </div>

        <div class="instructions">
            <h2>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
                    <path d="M12 16v-4M12 8h.01"/>
                </svg>
                How to Use
            </h2>
            <ol>
                <li>Click "Record Cough" and cough into your device's microphone</li>
                <li>Repeat this process until you have recorded at least 5 coughs (maximum 10)</li>
                <li>Click "Process Coughs" to analyze your recordings</li>
                <li>Wait for the results to be displayed</li>
            </ol>
        </div>

        <div class="warning">
            <h2>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <path d="M12 9v4M12 17h.01"/>
                </svg>
                Important Notice
            </h2>
            <p>This is a screening tool only and does not provide a medical diagnosis. If the results indicate a potential TB infection, please consult a healthcare professional for proper medical evaluation and testing.</p>
            <p>For accurate results, ensure you are in a quiet environment and speak clearly into your device's microphone.</p>
        </div>

        <div class="controls">
            <div class="button-group">
                <button id="recordButton" aria-label="Record cough">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Record Cough
                </button>
                <button id="processButton" disabled aria-label="Process recorded coughs">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                    Process Coughs
                </button>
                <button id="resetButton" aria-label="Reset all recordings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                        <path d="M3 3v5h5"/>
                    </svg>
                    Reset
                </button>
            </div>

            <div class="recording-indicator" role="status" aria-live="polite">
                <div class="recording-dot"></div>
                Recording...
                <span id="recording-timer" style="margin-left:0.75rem; font-weight:600; display:none;">2.0s</span>
            </div>

            <div class="progress-container">
                <div class="cough-count">
                    <span>Coughs recorded:</span>
                    <span class="count">0</span>
                    <span>/ 5 required</span>
                </div>
                <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-fill"></div>
                </div>
            </div>
        </div>

        <div id="results" role="region" aria-live="polite"></div>
    </div>

    <button id="infoButton" class="info-button" aria-label="Learn more about this tool">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4M12 8h.01" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="button-text">About This Tool</span>
    </button>

    <div id="infoOverlay" class="info-overlay">
        <div id="infoPanel" class="info-panel">
            <button class="close-button" aria-label="Close information panel">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
            <h2>
                <svg class="section-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16v-4M12 8h.01" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                About This Tool
            </h2>
            <h3>
                <svg class="section-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="4"/>
                    <path d="M8 9h8M8 13h6M8 17h4"/>
                </svg>
                How It Works
            </h3>
            <p style="text-align:justify;">This tool uses advanced machine learning technology to analyze cough sounds. Think of it like teaching a computer to recognize patterns in coughs, similar to how you might learn to recognize different types of music or voices.</p>
            <div class="stat-block">
                <div class="stat-item">30,000+<br><span style="font-weight:400;font-size:0.95rem;">Cough Samples</span></div>
                <div class="stat-item">86%<br><span style="font-weight:400;font-size:0.95rem;">Accuracy Rate*</span></div>
                <div class="stat-item">90%<br><span style="font-weight:400;font-size:0.95rem;">Sensitivity</span></div>
                <div class="stat-item">83%<br><span style="font-weight:400;font-size:0.95rem;">Specificity</span></div>
            </div>
            <p style="font-size:0.97rem; color:#64748b; margin-top:-1rem; margin-bottom:1.5rem; text-align:justify;">*The 86% accuracy rate refers to the model's performance on individual cough recordings. In this test, we ask you to record multiple coughs. We then aggregate and average the results from all your cough recordings, and make a final prediction using a 0.5 threshold. This means your overall result is based on a combination of your coughs, making the final prediction more reliable and likely even more accurate than the individual cough accuracy.</p>
            <hr class="section-divider"/>
            <h3>
                <svg class="section-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 20v-6M12 4v2M6 12h12"/>
                </svg>
                The Technology Behind It
            </h3>
            <p>Our system was trained on thousands of cough recordings from both TB-positive patients and healthy individuals. It learned to identify subtle patterns in cough sounds that might indicate TB, much like how a doctor listens for specific signs during a checkup.</p>
        </div>
    </div>

    <script>
        let recordedCoughs = [];
        const requiredCoughs = 5;
        const maxCoughs = 10;
        const recordButton = document.getElementById('recordButton');
        const processButton = document.getElementById('processButton');
        const resetButton = document.getElementById('resetButton');
        const recordingIndicator = document.querySelector('.recording-indicator');
        const progressFill = document.querySelector('.progress-fill');
        const coughCount = document.querySelector('.cough-count .count');
        const progressBar = document.querySelector('.progress-bar');
        const infoButton = document.querySelector('.info-button');
        const infoPanel = document.querySelector('.info-panel');
        const closeButton = document.querySelector('.close-button');
        const infoOverlay = document.getElementById('infoOverlay');
        let timerInterval = null;
        const recordingTimer = document.getElementById('recording-timer');

        function resetUI() {
            recordedCoughs = [];
            recordButton.disabled = false;
            processButton.disabled = true;
            recordingIndicator.classList.remove('active');
            recordButton.classList.remove('recording');
            recordButton.setAttribute('aria-label', 'Record cough');
            document.getElementById('results').innerHTML = '';
            updateProgress();
        }

        function updateProgress() {
            const progress = (recordedCoughs.length / requiredCoughs) * 100;
            progressFill.style.width = `${Math.min(progress, 100)}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            coughCount.textContent = recordedCoughs.length;
            
            // Update the required coughs text
            const requiredText = document.querySelector('.cough-count span:last-child');
            if (recordedCoughs.length >= requiredCoughs) {
                requiredText.textContent = `/ ${maxCoughs} maximum`;
            } else {
                requiredText.textContent = `/ ${requiredCoughs} required`;
            }
        }

        function showError(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="result-container">
                    <div class="error-message">
                        <h3>Error</h3>
                        <p>${message}</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Please try recording the coughs again.</p>
                    </div>
                </div>
            `;
        }

        recordButton.onclick = async () => {
            if (recordedCoughs.length >= maxCoughs) {
                showError(`You have already recorded the maximum number of coughs (${maxCoughs}). Please process your recordings.`);
                return;
            }

            // Disable the record button while recording
            recordButton.disabled = true;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mediaRecorder = new MediaRecorder(stream);
                const audioChunks = [];

                recordButton.classList.add('recording');
                recordingIndicator.classList.add('active');
                recordButton.setAttribute('aria-label', 'Recording cough...');

                // Show and start timer
                let timeLeft = 2.0;
                if (recordingTimer) {
                    recordingTimer.style.display = 'inline';
                    recordingTimer.textContent = `${timeLeft.toFixed(1)}s`;
                    timerInterval = setInterval(() => {
                        timeLeft -= 0.1;
                        if (timeLeft <= 0) {
                            recordingTimer.textContent = '0.0s';
                            clearInterval(timerInterval);
                        } else {
                            recordingTimer.textContent = `${timeLeft.toFixed(1)}s`;
                        }
                    }, 100);
                }

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    recordButton.classList.remove('recording');
                    recordingIndicator.classList.remove('active');
                    recordButton.setAttribute('aria-label', 'Record cough');
                    if (recordingTimer) {
                        recordingTimer.style.display = 'none';
                        clearInterval(timerInterval);
                    }

                    // Re-enable the record button if not at max coughs
                    if (recordedCoughs.length < maxCoughs) {
                        recordButton.disabled = false;
                    }

                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const formData = new FormData();
                    formData.append('audio', audioBlob);

                    try {
                        const response = await fetch('/record', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        recordedCoughs.push(data.filename);
                        updateProgress();

                        if (recordedCoughs.length >= requiredCoughs) {
                            processButton.disabled = false;
                        }

                        if (recordedCoughs.length >= maxCoughs) {
                            recordButton.disabled = true;
                            recordButton.setAttribute('aria-label', 'Maximum coughs recorded');
                        }
                    } catch (error) {
                        console.error('Error saving recording:', error);
                        showError('Failed to save recording. Please try again.');
                    }
                };

                mediaRecorder.start();
                setTimeout(() => mediaRecorder.stop(), 2000);
            } catch (error) {
                console.error('Error accessing microphone:', error);
                showError('Error accessing microphone. Please ensure you have granted microphone permissions.');
            }
        };

        processButton.onclick = async () => {
            processButton.disabled = true;
            processButton.innerHTML = `
                <div class="processing-animation">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" stroke-dasharray="50" stroke-dashoffset="20"/>
                    </svg>
                    Processing
                    <div class="dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
            `;
            processButton.setAttribute('aria-label', 'Processing coughs...');

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filenames: recordedCoughs })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to process coughs');
                }
                
                if (!data || !data.individual_results || !data.summary) {
                    throw new Error('Invalid response format from server');
                }
                
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = `
                    <div class="result-container" style="animation: slideIn 0.3s ease-out;">
                        <div class="summary">
                            <h2>Analysis Results</h2>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <h3>Overall Result</h3>
                                    <p style="color: ${data.summary.overall_result === 'TB POSITIVE' ? 'var(--danger-color)' : 'var(--success-color)'}">
                                        ${data.summary.overall_result}
                                    </p>
                                </div>
                                <div class="summary-item">
                                    <h3>Total Coughs</h3>
                                    <p>${data.summary.total_coughs}</p>
                                </div>
                                <div class="summary-item">
                                    <h3>Positive Coughs</h3>
                                    <p style="color: var(--danger-color)">${data.summary.positive_coughs}</p>
                                </div>
                                <div class="summary-item">
                                    <h3>Negative Coughs</h3>
                                    <p style="color: var(--success-color)">${data.summary.negative_coughs}</p>
                                </div>
                                <div class="summary-item">
                                    <h3>Average Probability</h3>
                                    <p>${(data.summary.average_probability * 100).toFixed(1)}%</p>
                                </div>
                            </div>
                        </div>
                        <div class="individual-results">
                            <h2>Individual Results</h2>
                            ${data.individual_results.map((result, index) => `
                                <div class="cough-result ${result.probability >= 0.5 ? 'positive' : 'negative'}" 
                                     style="animation: slideIn 0.3s ease-out ${index * 0.1}s">
                                    <h3>${result.result}</h3>
                                    <p>Confidence: ${(result.confidence * 100).toFixed(1)}%</p>
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: ${result.confidence * 100}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${data.summary.overall_result === 'TB POSITIVE' ? `
                            <div class="warning" style="margin-top: 2rem; animation: slideIn 0.3s ease-out 0.5s">
                                <h2>
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                        <path d="M12 9v4M12 17h.01"/>
                                    </svg>
                                    Next Steps
                                </h2>
                                <p>Based on the analysis, we recommend consulting a healthcare professional for proper medical evaluation and testing. Early detection and treatment are crucial for managing tuberculosis effectively.</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('Error processing coughs:', error);
                showError(error.message);
            } finally {
                processButton.disabled = false;
                processButton.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                    Process Coughs
                `;
                processButton.setAttribute('aria-label', 'Process recorded coughs');
            }
        };

        resetButton.onclick = () => {
            if (recordedCoughs.length > 0) {
                if (confirm('Are you sure you want to reset all recordings? This cannot be undone.')) {
                    resetUI();
                }
            }
        };

        function toggleInfoPanel() {
            infoPanel.classList.toggle('active');
            infoOverlay.classList.toggle('active');
            document.body.style.overflow = infoPanel.classList.contains('active') ? 'hidden' : '';
        }

        function closeInfoPanel() {
            infoPanel.classList.remove('active');
            infoOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        infoButton.onclick = toggleInfoPanel;
        if (closeButton) closeButton.onclick = closeInfoPanel;
        infoOverlay.onclick = closeInfoPanel;

        // Close panel when pressing Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && infoPanel.classList.contains('active')) {
                closeInfoPanel();
            }
        });
    </script>
</body>
</html> 